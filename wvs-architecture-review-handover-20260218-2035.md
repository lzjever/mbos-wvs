# WVS 架构复审移交任务书（面向外部架构团队）

## 1. 文档目的
本任务书用于将当前 WVS（Workspace Versioning Service）设计移交给独立架构团队进行二次审查，重点验证：

1. MVP 与 GA 路线划分是否合理
2. 方案是否可实现、可落地、可运维
3. 功能与接口是否逻辑闭环、无重大遗漏与冲突
4. 设计边界是否清晰，是否有效防止范围蔓延

审查团队需基于本任务书与 `wvs-tech-docs.md` 输出可执行结论与修订建议。

## 2. 被审查对象
唯一基线文档：`wvs-tech-docs.md`

审查对象包括但不限于：

1. 产品功能定义与范围控制
2. MVP/GA 分层策略
3. API 合约、任务模型、状态机
4. 数据模型与一致性约束
5. 运行与可观测性设计
6. Demo 与交付可验收性

## 3. 当前产品定位与MVP目的
### 3.1 产品定位
WVS 的核心目标是提供“AI 工作区版本控制能力”的最小可用闭环，采用 **snapshot + current** 模型：

1. `snapshot_create`
2. `set_current`
3. `snapshot_drop`

不引入 DAG、分支图、merge/rebase/cherry-pick 等复杂版本图能力。

### 3.2 MVP目的（必须达成）
MVP 目标不是“功能尽可能多”，而是“最小能力闭环 + 可稳定运行 + 可验证演示”：

1. 能安全创建/切换/删除快照
2. 能在并发与失败场景下保持一致性
3. 能通过 CLI/TUI 演示完整主流程
4. 能通过基础可观测手段定位故障
5. 能作为后续 GA 扩展的稳定基线

## 4. MVP与GA边界（审查重点）
### 4.1 MVP必须包含
1. Workspace 生命周期：create/get/list/retry-init/disable
2. Snapshot 能力：create/list/drop
3. Current 能力：get/set
4. 异步任务化执行与幂等
5. Quiesce 强制协议（clone 前冻结）
6. PostgreSQL 队列（SKIP LOCKED + advisory lock）
7. 审计日志
8. 可观测工具：metrics + structured logs + vmagent/vmsingle
9. 控制台 UXUI（wvsctl）可演示全流程
10. docker-compose 一键 demo

### 4.2 MVP明确不包含
1. DAG/分支图
2. 内容级 diff/merge
3. 多租户 RBAC
4. 生产级鉴权（MVP 允许无鉴权）
5. 生产级 K8s 安全加固
6. PITR 演练编排与高级告警运营

### 4.3 GA再引入
1. JWT/OIDC + RBAC
2. 多 executor 生产调度
3. PITR 编排与演练
4. vmauth/vmalert/Grafana 完整运维体系
5. K8s 生产化发布与安全基线

## 5. 关键设计前提（需逐条验证）
1. `set_current` 与 `snapshot_create` 执行前必须 quiesce，超时 fail-closed
2. `set_current` 若目标等于当前快照，必须 no-op 成功，不执行 clone
3. `snapshot_drop` 必须做引用保护：current 与可重试任务引用均不可删
4. `snapshot_drop` 固定顺序：先删目录，再写 `deleted_at`
5. 异步写接口必须强制 `Idempotency-Key`
6. 任务执行按 workspace 串行化，不允许同 workspace 并发 clone

## 6. 产品功能点检查任务（请外部团队执行）
请按以下清单逐项给出“通过/不通过/条件通过”结论，并附证据。

### 6.1 功能闭环检查
1. 是否存在“文档定义了功能，但缺少接口或状态承载”的断链
2. 是否存在“接口可调用，但无持久化字段支撑”的断链
3. 是否存在“状态可进入但无退出路径”的死状态
4. 是否存在“失败后无恢复路径”的僵局场景

### 6.2 接口契约检查
1. 每个 API 的前置条件是否可在服务端被确定性校验
2. 错误码是否覆盖所有业务冲突（幂等冲突、引用冲突、状态冲突）
3. list 接口分页是否统一且可实现
4. 删除与禁用语义是否一致（同步/异步、软删/硬删）

### 6.3 并发与一致性检查
1. workspace 级串行化是否足够覆盖 clone 冲突
2. 任务重试是否可能造成副作用重复
3. `deleted_at` 软删除语义是否与查询语义一致
4. current 指针更新与任务成功状态是否存在竞态

### 6.4 可观测与可运维检查
1. MVP 指标是否足够支持线上问题定位
2. 日志字段是否足以完成请求到任务的链路关联
3. 是否存在“能失败但无法被监控发现”的盲区
4. demo 运行步骤是否可重复、可验收

### 6.5 边界与范围控制检查
1. 文档是否仍存在可触发 scope creep 的“可选实现”描述
2. MVP 与 GA 是否存在交叉耦合导致 MVP 被 GA 阻塞
3. 是否要求开发团队主观决策关键语义（若是，需改为强制规则）

## 7. 重点关注风险（请优先审查）
1. Quiesce 协议与 agent 行为耦合风险（超时、未响应、误恢复）
2. 任务重试与幂等键复用风险
3. snapshot drop 的引用检测窗口期竞态
4. current 切换失败后的回滚与可恢复性
5. disable 后资源可见性、可操作性与审计一致性
6. MVP 无鉴权前提下的部署边界与误暴露风险

## 8. 期望外部团队输出物
请提供以下交付件：

1. 《复审结论摘要》
2. 《问题清单（按严重级别）》
3. 《修订建议（精确到文档段落/API/DDL/状态机）》
4. 《MVP 可上线前置条件列表》
5. 《GA 设计延后项与触发条件》

问题分级标准：

1. P0：阻断 MVP 落地或存在高概率数据不一致
2. P1：可落地但存在明显稳定性/可维护性风险
3. P2：优化项，不阻断 MVP

## 9. 审查方法建议
1. 先做“契约一致性审查”（API ↔ 状态机 ↔ DDL）
2. 再做“失败路径演算”（超时、重试、取消、执行器异常）
3. 最后做“交付验证审查”（demo、可观测、runbook）

禁止仅做原则性评价，必须给出可执行修订建议。

## 10. 完成标准（本轮复审）
外部团队审查完成以以下条件为准：

1. 所有 P0 问题有明确处置结论
2. MVP 关键流程（snapshot create → set_current → snapshot drop）被判定可实现
3. MVP/GA 边界无重大冲突
4. 输出文档可直接指导下一轮定稿

